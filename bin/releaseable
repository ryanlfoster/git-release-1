#!/bin/bash -e
set -e

############################################################
#####                  Releasable                      #####
### Pure bash script for handling git release versioning ###
############################################################


############################################################
#####                   DEFAULTS                       #####
############################################################

RELEASE_PREFIX='release/v'
CHANGELOG_FILE='CHANGELOG'
VERSION_FILE='VERSION'
CHANGELOG_SCOPE=':all_commits'
CHANGELOG_STRATEGY=':overwrite'

START_POINT=''
END_POINT=''

#Supporting functions
. "${BASH_SOURCE[0]%/*}/../support/support-functions.sh"

USAGE_OUTPUT="
usage : $(basename "$0") ${ARGP}${ARG_VERSION}${ARGA}'<version>' [${ARGP}${ARG_PREFIX}${ARGA}'<prefix>'] [${ARGP}${ARG_START}${ARGA}'<start>'] [${ARGP}${ARG_FINISH}${ARGA}'<finish>']
                         [${ARGP}${ARG_APPEND}] [${ARG_PULL_REQUESTS}] [${ARGP}${ARG_CHANGELOG}${ARGA}'<changelog_file>'] [${ARGP}${ARG_VERSION_FILE}${ARGA}'<version_file>']
                         [${ARGP}${ARG_HELP_TEXT}] [-t]
                         --- create git release tag with changelog

options:
  required:
    ${ARGP}${ARG_VERSION}${ARGA}'<version>'  set the software versioning type (major or minor or patch)
  optional:
    [${ARGP}${ARG_PREFIX}${ARGA}'<prefix>'] set the release prefix (default: 'release/v')
  changelog:
    [${ARGP}${ARG_START}${ARGA}'<start>']  set the start point (default: the last tag name that matches the prefix)
    [${ARGP}${ARG_FINISH}${ARGA}'<finish>'] set the end/finish point (default: HEAD)
    [${ARGP}${ARG_APPEND}]            append to changelog (default: overwrite)
    [${ARGP}${ARG_PULL_REQUESTS}]            set to only pull requests (default: all commits)
    [${ARGP}${ARG_CHANGELOG}${ARGA}'filename'] set the changelog filename (default: CHANGELOG)
    [${ARGP}${ARG_VERSION_FILE}${ARGA}'filename'] set the version file name (default: VERSION)
  general:
    ${ARGP}${ARG_HELP_TEXT}  show this help text
    -t  test only (will not execute script)


usage examples:

  1) Basic usage with defaults
    Given the last release was at 1.0.4, with a tag of 'our-releases/REL1.0.4' :

    $(basename "$0") ${ARGP}${ARG_VERSION}${ARGA}minor ${ARGP}${ARG_PREFIX}${ARGA}'our-releases/REL-'

    Tag generated           : our-releases/REL1.1.4
    Version file contains   : 1.1.4
    CHANGELOG file contains : commit information for all commits between last release and HEAD

  2) Pull requests only (changelog generated only with body of pull request titles)

    $(basename "$0") ${ARGP}${ARG_VERSION}${ARGA}minor ${ARGP}${ARG_PULL_REQUESTS}

  3) Generate custom changelog and version file

    $(basename "$0") ${ARGP}${ARG_VERSION}${ARGA}minor ${ARGP}${ARG_CHANGELOG}${ARGA}'MYCHANGELOGFILE' ${ARGP}${ARG_VERSION_FILE}${ARGA}'MYVERSIONFILE'

"

############################################################
#####                  INPUT CAPTURE                   #####
############################################################

while getopts t"$ARG_HELP_TEXT""$ARG_APPEND""$ARG_PULL_REQUESTS""$ARG_VERSION":"$ARG_START":"$ARG_FINISH":"$ARG_PREFIX":"$ARG_CHANGELOG":"$ARG_VERSION_FILE": option
do
  case "${option}"
  in
    $ARG_HELP_TEXT)
      echo "$USAGE_OUTPUT" >&2
      exit 0
      ;;
    t) SKIP_EXECUTE=true;;
    $ARG_PULL_REQUESTS) CHANGELOG_SCOPE=":pulls_only";;
    $ARG_APPEND) CHANGELOG_STRATEGY=":append";;
    $ARG_VERSION) VERSION_TYPE="$OPTARG";;
    $ARG_PREFIX) RELEASE_PREFIX="$OPTARG";;
    $ARG_START) START_POINT="$OPTARG";;
    $ARG_FINISH) END_POINT="$OPTARG";;
    $ARG_CHANGELOG) CHANGELOG_FILE="$OPTARG";;
    $ARG_VERSION_FILE) VERSION_FILE="$OPTARG";;

    ?)
      printf "illegal option: '%s'\n" "$OPTARG" >&2
      echo "$USAGE_OUTPUT" >&2
      exit 1
      ;;
  esac
done
shift $((OPTIND - 1))


if [ ! $SKIP_EXECUTE ]; then
  ############################################################
  #####                  VALIDATION                      #####
  ############################################################

  validate_version_type "$VERSION_TYPE" "$USAGE_OUTPUT"
  ensure_git_directory
  ensure_git_is_clean

  ############################################################
  #####                   RELEASE                        #####
  ############################################################
  last_tag_name=$(get_last_tag_name $RELEASE_PREFIX);

  if [[ "$START_POINT" = '' ]]; then
    START_POINT=$last_tag_name
  fi;

  next_version_number=$(get_next_version_number_from_tag $VERSION_TYPE $last_tag_name)
  next_tag_name="${RELEASE_PREFIX}${next_version_number}"
  generate_version_file "$next_version_number" "$VERSION_FILE"

  changelog_content=$(generate_changelog_content "$next_version_number" "$CHANGELOG_SCOPE" "$START_POINT" "$END_POINT")

  generate_changelog_file "$changelog_content" "$CHANGELOG_STRATEGY" "$CHANGELOG_FILE"

  set +e #Allow commit to fail if no files have changed
  git add -A
  git commit -m "Release : ${next_tag_name}"
  set -e

  git tag $next_tag_name

  #git push --tags
fi;
